# RKS-RKL ç½‘ç»œåŠŸèƒ½æµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº† RKS-RKL é›†ä¸­å¼ç½‘ç»œæž¶æž„çš„å®Œæ•´æµ‹è¯•æŒ‡å—ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¿…è¦çš„å‘½ä»¤å’Œé¢„æœŸç»“æžœã€‚

## çŽ¯å¢ƒè¦æ±‚

- Linux ç³»ç»Ÿ (Ubuntu/Debian/CentOS)
- Docker
- Rust å·¥å…·é“¾
- sudo æƒé™
- ç½‘ç»œç®¡ç†æƒé™

## å¿«é€Ÿæµ‹è¯• (æŽ¨è)

### ä¸€é”®è¿è¡Œå®Œæ•´æµ‹è¯•

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/rk8s-zh

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x project/rkl/test-network.sh

# è®¾ç½®ä¸»æœºIP (æ›¿æ¢ä¸ºä½ çš„å®žé™…IP)
export HOST_IP="192.168.3.20"

# è¿è¡Œå®Œæ•´æµ‹è¯•
./project/rkl/test-network.sh all
```

**é¢„æœŸç»“æžœï¼š**
```
=== RKS-RKL ç½‘ç»œåŠŸèƒ½é›†æˆæµ‹è¯• ===
ä¸»æœºIP: 192.168.3.20
RKSç«¯å£: 50051
etcdç«¯å£: 2379
èŠ‚ç‚¹ID: test-node-your-hostname

âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ
âœ… etcdé…ç½®å®Œæˆ
âœ… RKSé…ç½®å‡†å¤‡å®Œæˆ
âœ… RKLæ¨¡å—æµ‹è¯•å®Œæˆ
âœ… RKLé…ç½®å‡†å¤‡å®Œæˆ
âœ… RKSå¯åŠ¨å®Œæˆ
âœ… RKLå¯åŠ¨å®Œæˆ
âœ… ç½‘ç»œé…ç½®éªŒè¯å®Œæˆ
âœ… æ—¥å¿—æ£€æŸ¥å®Œæˆ

ðŸŽ‰ æµ‹è¯•å®Œæˆï¼
```

## åˆ†æ­¥æµ‹è¯• (è¯¦ç»†)

å¦‚æžœå¿«é€Ÿæµ‹è¯•å¤±è´¥ï¼Œå¯ä»¥åˆ†æ­¥æ‰§è¡Œæ¥å®šä½é—®é¢˜ï¼š

### æ­¥éª¤ 1: çŽ¯å¢ƒè®¾ç½®

```bash
# è®¾ç½®çŽ¯å¢ƒ
./project/rkl/test-network.sh setup
```

**é¢„æœŸç»“æžœï¼š**
- etcd å®¹å™¨å¯åŠ¨æˆåŠŸ
- ç½‘ç»œé…ç½®å†™å…¥ etcd
- RKS å’Œ RKL é…ç½®æ–‡ä»¶ç”Ÿæˆ

**éªŒè¯å‘½ä»¤ï¼š**
```bash
# æ£€æŸ¥ etcd çŠ¶æ€
docker ps | grep etcd

# æ£€æŸ¥ç½‘ç»œé…ç½®
docker exec etcd etcdctl --endpoints=http://localhost:2379 get /coreos.com/network/config
```

**é¢„æœŸè¾“å‡ºï¼š**
```json
{"Network":"10.1.0.0/16","SubnetMin":"10.1.1.0","SubnetMax":"10.1.254.0","SubnetLen":24,"EnableIPv4":true,"EnableIPv6":false,"Backend":{"Type":"hostgw"}}
```

### æ­¥éª¤ 2: RKL æ¨¡å—æµ‹è¯•

```bash
# è¿è¡Œ RKL å•å…ƒæµ‹è¯•
./project/rkl/test-network.sh test
```

**é¢„æœŸç»“æžœï¼š**
```
ç¼–è¯‘RKL...
   Compiling rkl v0.1.0
    Finished release [optimized] target(s)

è¿è¡Œç½‘ç»œæ¨¡å—å•å…ƒæµ‹è¯•...
test network::config::tests::test_validate_network_config ... ok
test network::route::tests::test_route_equal ... ok  
test network::subnet::tests::test_parse_subnet_key ... ok
test network::subnet::tests::test_write_subnet_file ... ok
test network::receiver::tests::test_network_receiver_builder ... ok

è¿è¡Œé›†æˆæµ‹è¯•...
test test_network_config_parsing ... ok
test test_network_receiver_builder ... ok
test test_full_network_config_message ... ok

âœ… RKLæ¨¡å—æµ‹è¯•å®Œæˆ
```

### æ­¥éª¤ 3: å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ RKS å’Œ RKL æœåŠ¡
./project/rkl/test-network.sh start
```

**é¢„æœŸç»“æžœï¼š**
```
å¯åŠ¨RKSæœåŠ¡...
ç­‰å¾…RKSå¯åŠ¨...
RKSå·²å¯åŠ¨ (PID: 12345)
âœ… RKSå¯åŠ¨å®Œæˆ

å¯åŠ¨RKLæœåŠ¡...
RKLå·²å¯åŠ¨ (PID: 12346)
âœ… RKLå¯åŠ¨å®Œæˆ
```

**éªŒè¯æœåŠ¡çŠ¶æ€ï¼š**
```bash
# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep :50051

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep -E "(rks|rkl)" | grep -v grep
```

### æ­¥éª¤ 4: éªŒè¯ç½‘ç»œé…ç½®

```bash
# éªŒè¯ç½‘ç»œåŠŸèƒ½
./project/rkl/test-network.sh verify
```

**é¢„æœŸç»“æžœï¼š**

#### 4.1 subnet.env æ–‡ä»¶ç”Ÿæˆ
```bash
cat /tmp/rkl-test/subnet.env
```
**é¢„æœŸè¾“å‡ºï¼š**
```
RKL_NETWORK=10.1.0.0/16
RKL_SUBNET=10.1.1.0/24
RKL_MTU=1500
RKL_IPMASQ=true
```

#### 4.2 ç³»ç»Ÿè·¯ç”±æ·»åŠ 
```bash
ip route show | grep "10.1"
```
**é¢„æœŸè¾“å‡ºï¼š**
```
10.1.2.0/24 via 192.168.3.21 dev eth0 metric 100
10.1.3.0/24 via 192.168.3.22 dev eth0 metric 100
```

#### 4.3 etcd ä¸­çš„ lease ä¿¡æ¯
```bash
docker exec etcd etcdctl --endpoints=http://localhost:2379 get --prefix /coreos.com/network/subnets/
```
**é¢„æœŸè¾“å‡ºï¼š**
```
/coreos.com/network/subnets/10.1.1.0-24
{"PublicIP":"192.168.3.20","BackendType":"hostgw"}
```

## æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤

å¦‚æžœè„šæœ¬ä¸å¯ç”¨ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

### 1. å¯åŠ¨ etcd

```bash
# å¯åŠ¨ etcd å®¹å™¨
docker run -d --name etcd --network host \
    quay.io/coreos/etcd:v3.5.9 \
    etcd \
    --listen-client-urls=http://0.0.0.0:2379 \
    --advertise-client-urls=http://192.168.3.20:2379 \
    --listen-peer-urls=http://0.0.0.0:2380 \
    --initial-advertise-peer-urls=http://192.168.3.20:2380 \
    --initial-cluster=default=http://192.168.3.20:2380 \
    --name=default \
    --data-dir=/etcd-data

# é…ç½®ç½‘ç»œå‚æ•°
docker exec etcd etcdctl --endpoints=http://localhost:2379 put /coreos.com/network/config '{
    "Network":"10.1.0.0/16",
    "SubnetMin":"10.1.1.0",
    "SubnetMax":"10.1.254.0",
    "SubnetLen":24,
    "EnableIPv4":true,
    "EnableIPv6":false,
    "Backend":{"Type":"hostgw"}
}'
```

### 2. åˆ›å»º RKS é…ç½®

```bash
cat > /tmp/rks-config.yaml << EOF
addr: "192.168.3.20:50051"
etcd_endpoints: ["http://192.168.3.20:2379"]
data_dir: "/tmp/rks-data"
node_name: "rks-test"
network:
  enable: true
  backend: "hostgw"
EOF
```

### 3. å¯åŠ¨ RKS

```bash
cd project/rks
export RUST_LOG=rks=info,rks::network=debug
cargo run --release -- start --config /tmp/rks-config.yaml
```

### 4. åˆ›å»º RKL é…ç½®

```bash
sudo mkdir -p /tmp/rkl-test /etc/cni/net.d

cat > /tmp/rkl-test/config.toml << EOF
[network]
subnet_file_path = "/tmp/rkl-test/subnet.env"
rks_endpoint = "192.168.3.20:50051"
node_id = "test-node-manual"
link_index = 1
backend_type = "hostgw"
EOF
```

### 5. å¯åŠ¨ RKL

```bash
cd project/rkl
export RUST_LOG=rkl=info,rkl::network=debug
sudo -E env "PATH=$PATH" cargo run --release -- daemon --config /tmp/rkl-test/config.toml
```

### 6. æµ‹è¯• kubectl åŠŸèƒ½ (å¯é€‰)

```bash
# åˆ›å»ºç¤ºä¾‹ pod é…ç½®
cat > /tmp/test-pod.yaml << EOF
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: test-container
    image: nginx:latest
    ports:
    - containerPort: 80
EOF

# ä½¿ç”¨ rkl_cli åˆ›å»º pod
cd project/rks  
cargo run --bin rkl_cli -- --server http://192.168.3.20:50051 create /tmp/test-pod.yaml

# éªŒè¯å®¹å™¨
docker ps | grep test

# åˆ é™¤ pod
cargo run --bin rkl_cli -- --server http://192.168.3.20:50051 delete test-pod
```

## æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

#### 1. etcd å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥ etcd æ—¥å¿—
docker logs etcd

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 2379

# é‡æ–°å¯åŠ¨
docker stop etcd && docker rm etcd
# ç„¶åŽé‡æ–°è¿è¡Œå¯åŠ¨å‘½ä»¤
```

#### 2. RKS è¿žæŽ¥ etcd å¤±è´¥
```bash
# æ£€æŸ¥ etcd è¿žé€šæ€§
curl http://192.168.3.20:2379/health

# æ£€æŸ¥ RKS æ—¥å¿—
tail -f /tmp/rks.log

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo iptables -L
```

#### 3. RKL è¿žæŽ¥ RKS å¤±è´¥
```bash
# æ£€æŸ¥ RKS ç«¯å£
nc -z 192.168.3.20 50051

# æ£€æŸ¥ RKL æ—¥å¿—
sudo tail -f /tmp/rkl.log

# æ£€æŸ¥ QUIC è¿žæŽ¥
grep -i quic /tmp/rkl.log
```

#### 4. è·¯ç”±æ·»åŠ å¤±è´¥
```bash
# æ£€æŸ¥æƒé™
sudo -v

# æ‰‹åŠ¨æµ‹è¯•è·¯ç”±æ·»åŠ 
sudo ip route add 10.1.99.0/24 via 192.168.3.1 dev eth0
sudo ip route del 10.1.99.0/24

# æ£€æŸ¥ç½‘ç»œæŽ¥å£
ip link show
```

### æ—¥å¿—ä½ç½®

- **RKS æ—¥å¿—**: `/tmp/rks.log`
- **RKL æ—¥å¿—**: `/tmp/rkl.log`  
- **etcd æ—¥å¿—**: `docker logs etcd`
- **ç³»ç»Ÿè·¯ç”±**: `ip route show`
- **etcd æ•°æ®**: `docker exec etcd etcdctl get --prefix /`

## æ¸…ç†çŽ¯å¢ƒ

æµ‹è¯•å®ŒæˆåŽæ¸…ç†çŽ¯å¢ƒï¼š

```bash
# ä½¿ç”¨è„šæœ¬æ¸…ç†
./project/rkl/test-network.sh cleanup

# æˆ–æ‰‹åŠ¨æ¸…ç†
sudo pkill -f "cargo run.*rkl"
pkill -f "cargo run.*rks"
docker stop etcd && docker rm etcd
sudo rm -rf /tmp/rkl-test /tmp/rks-data
rm -f /tmp/rks.log /tmp/rkl.log /tmp/*config*
```

## æˆåŠŸæ ‡å‡†

æµ‹è¯•æˆåŠŸçš„æ ‡å¿—ï¼š

1. âœ… etcd æ­£å¸¸å¯åŠ¨å¹¶åŒ…å«ç½‘ç»œé…ç½®
2. âœ… RKS æˆåŠŸè¿žæŽ¥ etcd å¹¶å¯åŠ¨ç›‘å¬
3. âœ… RKL æˆåŠŸè¿žæŽ¥ RKS å¹¶æ³¨å†ŒèŠ‚ç‚¹
4. âœ… subnet.env æ–‡ä»¶æ­£ç¡®ç”Ÿæˆ
5. âœ… ç³»ç»Ÿè·¯ç”±æ­£ç¡®æ·»åŠ 
6. âœ… etcd ä¸­å­˜åœ¨ç½‘ç»œ lease ä¿¡æ¯
7. âœ… æ—¥å¿—æ˜¾ç¤ºæ­£å¸¸çš„ç½‘ç»œé…ç½®åŒæ­¥

å®Œæˆè¿™äº›éªŒè¯åŽï¼Œè¯´æ˜Ž RKS-RKL é›†ä¸­å¼ç½‘ç»œæž¶æž„å·¥ä½œæ­£å¸¸ï¼
